<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/000037-AWSCloudFormation/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=000037-AWSCloudFormation/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.127.0">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/000037-AWSCloudFormation/images/favicon.png" type="image/png">

    <title>Tạo Lambda Function :: AWS CLOUDFORMATION</title>

    
    <link href="/000037-AWSCloudFormation/css/nucleus.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/fontawesome-all.min.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/hybrid.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/featherlight.min.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/perfect-scrollbar.min.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/auto-complete.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/atom-one-dark-reasonable.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/theme.css?1725786021" rel="stylesheet">
    <link href="/000037-AWSCloudFormation/css/hugo-theme.css?1725786021" rel="stylesheet">
    
    <link href="/000037-AWSCloudFormation/css/theme-workshop.css?1725786021" rel="stylesheet">
    
    

    <script src="/000037-AWSCloudFormation/js/jquery-3.3.1.min.js?1725786021"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.1-createlambdafunction/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/000037-AWSCloudFormation/js/lunr.min.js?1725786021"></script>
<script type="text/javascript" src="/000037-AWSCloudFormation/js/auto-complete.js?1725786021"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/minhtien088.github.io\/000037-AWSCloudFormation\/\/vi";
    
</script>
<script type="text/javascript" src="/000037-AWSCloudFormation/js/search.js?1725786021"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/1-introduce/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/1-introduce/">
           <b> 1. </b> Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/2-prerequiste/" title="Các bước chuẩn bị" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/2-prerequiste/">
           <b> 2. </b> Các bước chuẩn bị
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/2-prerequiste/2.1-createiamrole/" title="Tạo IAM Role" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/2-prerequiste/2.1-createiamrole/">
           <b> 2.1 </b> Tạo IAM Role
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/2-prerequiste/2.2-createiamuser/" title="Tạo IAM User" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/2-prerequiste/2.2-createiamuser/">
           <b> 2.2 </b> Tạo IAM User
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/2-prerequiste/2.3-switchrole/" title="Switch Role" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/2-prerequiste/2.3-switchrole/">
           <b> 2.3 </b> Switch Role
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/3-basiccloudformation/" title="CloudFormation cơ bản" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/3-basiccloudformation/">
           <b> 3. </b> CloudFormation cơ bản
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/3-basiccloudformation/3.1-usingcloudshell/" title="Sử dụng CloudShell" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/3-basiccloudformation/3.1-usingcloudshell/">
           <b> 3.1. </b> Sử dụng CloudShell
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/3-basiccloudformation/3.2-createcloudformationtemplate/" title="Tạo CloudFormation Template" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/3-basiccloudformation/3.2-createcloudformationtemplate/">
           <b> 3.2. </b> Tạo CloudFormation Template
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/" title="CloudFormation nâng cao" class="dd-item 
        parent
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/">
           <b> 4. </b> CloudFormation nâng cao
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/" title="Các tài nguyên tùy chỉnh" class="dd-item 
        parent
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/">
           <b> 4.1 </b> Các tài nguyên tùy chỉnh
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.1-createlambdafunction/" title="Tạo Lambda Function" class="dd-item 
        
        active
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.1-createlambdafunction/">
           <b> 4.1.1 </b> Tạo Lambda Function
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.2-createstack/" title="Tạo Stack" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.2-createstack/">
           <b> 4.1.2 </b> Tạo Stack
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.3-connectec2instance/" title="Kết nối EC2 Instance" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.3-connectec2instance/">
           <b> 4.1.3 </b> Kết nối EC2 Instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.2-mappingandstackset/" title="Ánh xạ và Stacksets" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.2-mappingandstackset/">
           <b> 4.2 </b> Ánh xạ và Stacksets
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.3-driftdetection/" title="Drift Detection" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.3-driftdetection/">
           <b> 4.3 </b> Drift Detection
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/000037-AWSCloudFormation/vi/5-cleanup/" title="Dọn dẹp tài nguyên" class="dd-item 
        
        
        
        ">
      <a href="/000037-AWSCloudFormation/vi/5-cleanup/">
           <b> 5. </b> Dọn dẹp tài nguyên
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="http://awsstudygroup.com/"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group - Nhóm FB</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="http://minhtien088.github.io/000037-AWSCloudFormation/4-advancedcloudformation/4.1-customresources/4.1.1-createlambdafunction/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="http://minhtien088.github.io/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.1-createlambdafunction/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>08-09-2024</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/jotaguy/"  style="color:orange">Gia Hưng </a> <br>
                <a href="https://www.linkedin.com/in/anhngo1610/"  style="color:orange">Tuấn Anh  </a> <br>
                <a href="https://www.linkedin.com/in/thmt2504/"  style="color:orange">Minh Tiến </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/000037-AWSCloudFormation/vi/'>AWS CloudFormation</a> > <a href='/000037-AWSCloudFormation/vi/4-advancedcloudformation/'>CloudFormation nâng cao</a> > <a href='/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/'>Các tài nguyên tùy chỉnh</a> > Tạo Lambda Function
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Tạo Lambda Function
            </h1>
          

        



	<h4 id="tạo-lambda-function">Tạo Lambda Function</h4>
<ol>
<li>Truy cập vào giao diện <a href="https://console.aws.amazon.com/console/">AWS Management Console</a></li>
</ol>
<ul>
<li>Tìm <strong>IAM</strong></li>
<li>Chọn <strong>IAM</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0001-createlambdafunction.png?width=5120px"></p>
<ol start="2">
<li>Trong giao diện <strong>IAM</strong></li>
</ol>
<ul>
<li>Chọn <strong>Policies</strong></li>
<li>Chọn <strong>Create policy</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0002-createlambdafunction.png?width=5120px"></p>
<ol start="3">
<li>Trong giao diện <strong>Create policy</strong></li>
</ol>
<ul>
<li>Chọn <strong>JSON</strong></li>
<li>Sao chép và dán vào đoạn mã sau:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Statement&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;logs:PutLogEvents&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:logs:*:*:*&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ec2:CreateKeyPair&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ec2:DescribeKeyPairs&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ssm:PutParameter&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Action&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ec2:DeleteKeyPair&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ssm:DeleteParameter&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Chọn <strong>Next</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0003-createlambdafunction.png?width=5120px"></p>
<ol start="4">
<li>Trong bước <strong>Review and create</strong></li>
</ol>
<ul>
<li><strong>Policy name</strong>, Nhập <code>ssh-key-gen-policy</code></li>
<li>Xem các dịch vụ được <strong>Allow</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0004-createlambdafunction.png?width=5120px"></p>
<ol start="5">
<li>Trong phần <strong>Add tags</strong></li>
</ol>
<ul>
<li>Nhập <strong>Key</strong>, ví dụ: <code>Name</code></li>
<li>Nhập <strong>Value</strong>, ví dụ: <code>CloudFormationWorkshop</code></li>
<li>Chọn <strong>Create policy</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0005-createlambdafunction.png?width=5120px"></p>
<ol start="6">
<li>Tạo policy <strong>ssh-key-gen-policy</strong> thành công</li>
</ol>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0006-createlambdafunction.png?width=5120px"></p>
<ol start="7">
<li>Trong giao diện <strong>IAM</strong></li>
</ol>
<ul>
<li>Chọn <strong>Roles</strong></li>
<li>Chọn <strong>Create role</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0007-createlambdafunction.png?width=5120px"></p>
<ol start="8">
<li>Trong bước <strong>Select trusted entity</strong></li>
</ol>
<ul>
<li><strong>Trusted entity type</strong>, chọn <strong>AWS service</strong></li>
<li><strong>User case</strong>, chọn <strong>Lambda</strong></li>
<li>Chọn <strong>Next</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0008-createlambdafunction.png?width=5120px"></p>
<ol start="9">
<li>Trong bước <strong>Add permissions</strong></li>
</ol>
<ul>
<li>Tìm và chọn policy <strong>ssh-key-gen-policy</strong></li>
<li>Chọn <strong>Next</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/0009-createlambdafunction.png?width=5120px"></p>
<ol start="10">
<li>Trong giao diện <strong>Role details</strong></li>
</ol>
<ul>
<li><strong>Role name</strong>, nhập <code>ssh-key-gen-role</code></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00010-createlambdafunction.png?width=5120px"></p>
<ol start="11">
<li>Kiểm tra lại and trong phần <strong>Add tags</strong></li>
</ol>
<ul>
<li>Nhập <strong>Key</strong>, ví dụ: <code>Name</code></li>
<li>Nhập <strong>Value</strong>, ví dụ: <code>CloudFormationWorkshop</code></li>
<li>Chọn <strong>Create role</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00011-createlambdafunction.png?width=5120px"></p>
<ol start="12">
<li>Trong giao diện <strong>IAM</strong></li>
</ol>
<ul>
<li>Tìm <strong>ssh-key-gen-role</strong></li>
<li>Xem role đã tạo</li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00012-createlambdafunction.png?width=5120px"></p>
<ol start="13">
<li>Trong giao diện <a href="https://aws.amazon.com/console/">AWS Management Console</a></li>
</ol>
<ul>
<li>Tìm <strong>Lambda</strong></li>
<li>Chọn <strong>Lambda</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00013-createlambdafunction.png?width=5120px"></p>
<ol start="14">
<li>Trong giao diện <strong>AWS Lambda</strong></li>
</ol>
<ul>
<li>Chọn <strong>Functions</strong></li>
<li>Chọn <strong>Create function</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00014-createlambdafunction.png?width=5120px"></p>
<ol start="15">
<li>Trong giao diện <strong>Create funtion</strong></li>
</ol>
<ul>
<li>Chọn <strong>Author from scratch</strong></li>
<li><strong>Function name</strong>, nhập <code>ssh-key-gen</code></li>
<li><strong>Run time</strong>, chọn <strong>Python 3.9</strong></li>
<li>Chọn <strong>x86_64</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00015-createlambdafunction.png?width=5120px"></p>
<ol start="16">
<li>Trong giao diện <strong>Permissions</strong></li>
</ol>
<ul>
<li>Chọn <strong>Use an existing role</strong></li>
<li>Chọn <strong>ssh-key-gen-role</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00016-createlambdafunction.png?width=5120px"></p>
<ol start="17">
<li>Trong nội dung chỉnh sửa Function code, nhập vào nội dung mã lệnh như sau:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This lambda implements the custom resource handler for creating an SSH key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">and storing in in SSM parameter store.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">e.g.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SSHKeyCR:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Type: Custom::CreateSSHKey
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Version: &#34;1.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Properties:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ServiceToken: !Ref FunctionArn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      KeyName: MyKey
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">An SSH key called MyKey will be created.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> json <span style="color:#f92672">import</span> dumps
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> traceback
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib.request
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> botocore.exceptions <span style="color:#f92672">import</span> ClientError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_exception</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Log a stack trace&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    exc_type, exc_value, exc_traceback <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>exc_info()
</span></span><span style="display:flex;"><span>    print(repr(traceback<span style="color:#f92672">.</span>format_exception(exc_type, exc_value, exc_traceback)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_response</span>(event, context, response):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Send a response to CloudFormation to handle the custom resource lifecycle&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    responseBody <span style="color:#f92672">=</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Status&#39;</span>: response,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Reason&#39;</span>: <span style="color:#e6db74">&#39;See details in CloudWatch Log Stream: &#39;</span> <span style="color:#f92672">+</span> context<span style="color:#f92672">.</span>log_stream_name,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;PhysicalResourceId&#39;</span>: context<span style="color:#f92672">.</span>log_stream_name,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;StackId&#39;</span>: event[<span style="color:#e6db74">&#39;StackId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;RequestId&#39;</span>: event[<span style="color:#e6db74">&#39;RequestId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;LogicalResourceId&#39;</span>: event[<span style="color:#e6db74">&#39;LogicalResourceId&#39;</span>],
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;RESPONSE BODY: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> dumps(responseBody))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> dumps(responseBody)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    req <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>Request(event[<span style="color:#e6db74">&#39;ResponseURL&#39;</span>], data, headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;Content-Length&#39;</span>: len(data), <span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>})
</span></span><span style="display:flex;"><span>    req<span style="color:#f92672">.</span>get_method <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span>: <span style="color:#e6db74">&#39;PUT&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>urlopen(req) <span style="color:#66d9ef">as</span> response:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;response.status: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>status<span style="color:#e6db74">}</span><span style="color:#e6db74">, response.reason: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>reason<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;response from cfn: &#39;</span> <span style="color:#f92672">+</span> response<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> urllib<span style="color:#f92672">.</span>error<span style="color:#f92672">.</span>URLError:
</span></span><span style="display:flex;"><span>        log_exception()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;Received non-200 response while sending response to AWS CloudFormation&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">custom_resource_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This function creates a PEM key, commits it as a key pair in EC2, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    and stores it, encrypted, in SSM.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    To retrieve the key with currect RSA format, you must use the command line: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    aws ssm get-parameter </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">        --name &lt;KEYNAME&gt; </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">        --with-decryption </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">        --region &lt;REGION&gt; </span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">        --output text
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Copy the values from (and including) -----BEGIN RSA PRIVATE KEY----- to 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -----END RSA PRIVATE KEY----- into a file.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    To use it, change the permissions to 600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Ensure to bundle the necessary packages into the zip stored in S3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Event JSON: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> dumps(event))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    request_type <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;RequestType&#39;</span>]
</span></span><span style="display:flex;"><span>    resource_properties <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;ResourceProperties&#39;</span>]
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FAILED&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> event[<span style="color:#e6db74">&#39;ResourceType&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Custom::CreateSSHKey&#39;</span>:
</span></span><span style="display:flex;"><span>        pem_key_name <span style="color:#f92672">=</span> resource_properties[<span style="color:#e6db74">&#39;KeyName&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ec2 <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;ec2&#39;</span>)
</span></span><span style="display:flex;"><span>        ssm_client <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;ssm&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Create&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Check if key already exists</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                    ec2<span style="color:#f92672">.</span>describe_key_pairs(KeyNames<span style="color:#f92672">=</span>[pem_key_name])
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Key pair </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> already exists. Skipping creation.&#34;</span>)
</span></span><span style="display:flex;"><span>                    response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SUCCESS&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">except</span> ClientError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>response[<span style="color:#e6db74">&#39;Error&#39;</span>][<span style="color:#e6db74">&#39;Code&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;InvalidKeyPair.NotFound&#39;</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e"># Key does not exist, create it</span>
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">&#34;Creating key name </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> str(pem_key_name))
</span></span><span style="display:flex;"><span>                        key <span style="color:#f92672">=</span> ec2<span style="color:#f92672">.</span>create_key_pair(KeyName<span style="color:#f92672">=</span>pem_key_name)
</span></span><span style="display:flex;"><span>                        key_material <span style="color:#f92672">=</span> key[<span style="color:#e6db74">&#39;KeyMaterial&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        param <span style="color:#f92672">=</span> ssm_client<span style="color:#f92672">.</span>put_parameter(Name<span style="color:#f92672">=</span>pem_key_name, Value<span style="color:#f92672">=</span>key_material, Type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;SecureString&#39;</span>)
</span></span><span style="display:flex;"><span>                        print(param)
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The parameter </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> has been created.&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SUCCESS&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">raise</span> e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;There was an error </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74"> creating and committing key </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> to the parameter store&#39;</span>)
</span></span><span style="display:flex;"><span>                log_exception()
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FAILED&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            send_response(event, context, response)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Update&#39;</span>:
</span></span><span style="display:flex;"><span>            send_response(event, context, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Delete&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Deleting key name </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                ssm_client<span style="color:#f92672">.</span>delete_parameter(Name<span style="color:#f92672">=</span>pem_key_name)
</span></span><span style="display:flex;"><span>                ec2<span style="color:#f92672">.</span>delete_key_pair(KeyName<span style="color:#f92672">=</span>pem_key_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SUCCESS&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;There was an error </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74"> deleting the key </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> from SSM Parameter store or EC2&#34;</span>)
</span></span><span style="display:flex;"><span>                log_exception()
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FAILED&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            send_response(event, context, response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lambda handler for the custom resource&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> custom_resource_handler(event, context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>        log_exception()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span></code></pre></div><ul>
<li>
<p>Hãy cùng nhau phân tích đoạn mã lệnh này có những nội dung gì nhé</p>
</li>
<li>
<p><strong>Thứ nhất: Hàm Handler</strong> - mọi lambda function đều có một hàm handler và chúng được gọi khi có bất kì một sự kiện nào xảy ra. Nội dung của hàm Handler chỉ đơn giản gọi tới một hàm khác chứa nội dung xử lý cụ thể với sự kiện vừa xảy ra.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Lambda handler for the custom resource&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> custom_resource_handler(event, context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>        log_exception()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span></code></pre></div><ul>
<li><strong>Thứ hai: hàm custom_resource_handler</strong> - là hàm chứa nội dung xử lý chi tiết khi có sự sự kiện xảy ra. Cụ thể, hàm sẽ thực hiện xác định loại yêu cầu và gửi trả phản hồi lại cho CloudFormation.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> request_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Create&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if key already exists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            ec2<span style="color:#f92672">.</span>describe_key_pairs(KeyNames<span style="color:#f92672">=</span>[pem_key_name])
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Key pair </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> already exists. Skipping creation.&#34;</span>)
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SUCCESS&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> ClientError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>response[<span style="color:#e6db74">&#39;Error&#39;</span>][<span style="color:#e6db74">&#39;Code&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;InvalidKeyPair.NotFound&#39;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Key does not exist, create it</span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Creating key name </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> str(pem_key_name))
</span></span><span style="display:flex;"><span>                key <span style="color:#f92672">=</span> ec2<span style="color:#f92672">.</span>create_key_pair(KeyName<span style="color:#f92672">=</span>pem_key_name)
</span></span><span style="display:flex;"><span>                key_material <span style="color:#f92672">=</span> key[<span style="color:#e6db74">&#39;KeyMaterial&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                param <span style="color:#f92672">=</span> ssm_client<span style="color:#f92672">.</span>put_parameter(Name<span style="color:#f92672">=</span>pem_key_name, Value<span style="color:#f92672">=</span>key_material, Type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;SecureString&#39;</span>)
</span></span><span style="display:flex;"><span>                print(param)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The parameter </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> has been created.&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SUCCESS&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;There was an error </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74"> creating and committing key </span><span style="color:#e6db74">{</span>pem_key_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> to the parameter store&#39;</span>)
</span></span><span style="display:flex;"><span>        log_exception()
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FAILED&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    send_response(event, context, response)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span></code></pre></div><ul>
<li><strong>Thứ ba: hàm send_response</strong> - là hàm gửi tra kết quả phản hồi cho CloudFormation endpoint dựa trên phương thức HTTP PUTS.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_response</span>(event, context, response):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Send a response to CloudFormation to handle the custom resource lifecycle&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    responseBody <span style="color:#f92672">=</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Status&#39;</span>: response,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Reason&#39;</span>: <span style="color:#e6db74">&#39;See details in CloudWatch Log Stream: &#39;</span> <span style="color:#f92672">+</span> context<span style="color:#f92672">.</span>log_stream_name,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;PhysicalResourceId&#39;</span>: context<span style="color:#f92672">.</span>log_stream_name,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;StackId&#39;</span>: event[<span style="color:#e6db74">&#39;StackId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;RequestId&#39;</span>: event[<span style="color:#e6db74">&#39;RequestId&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;LogicalResourceId&#39;</span>: event[<span style="color:#e6db74">&#39;LogicalResourceId&#39;</span>],
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;RESPONSE BODY: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> dumps(responseBody))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> dumps(responseBody)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    req <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>Request(event[<span style="color:#e6db74">&#39;ResponseURL&#39;</span>], data, headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;Content-Length&#39;</span>: len(data), <span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>})
</span></span><span style="display:flex;"><span>    req<span style="color:#f92672">.</span>get_method <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span>: <span style="color:#e6db74">&#39;PUT&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>urlopen(req) <span style="color:#66d9ef">as</span> response:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;response.status: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>status<span style="color:#e6db74">}</span><span style="color:#e6db74">, response.reason: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>reason<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;response from cfn: &#39;</span> <span style="color:#f92672">+</span> response<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> urllib<span style="color:#f92672">.</span>error<span style="color:#f92672">.</span>URLError:
</span></span><span style="display:flex;"><span>        log_exception()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;Received non-200 response while sending response to AWS CloudFormation&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><ul>
<li>Chỉnh sửa code và chọn <strong>Deploy</strong></li>
</ul>
<p><img alt="Create Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00017-createlambdafunction.png?width=5120px"></p>
<ol start="18">
<li>Sau khi lưu Function, chuyển đến tab <strong>Configuration</strong>, chọn phần <strong>General configuration</strong> và nhấn nút <strong>Edit</strong></li>
</ol>
<p><img alt="Tạo Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00019-createlambdafunction.png?width=5120px"></p>
<ol start="19">
<li>Chúng ta sẽ tăng thời gian chờ của Lambda function để tránh lỗi. Đặt thời gian chờ thành <strong>15 minutes</strong> rồi nhấn nút <strong>Save</strong></li>
</ol>
<p><img alt="Tạo Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00020-createlambdafunction.png?width=5120px"></p>
<ol start="20">
<li>Sau khi tăng thời gian chờ của Function, thực hiện sao chép Function ARN ra mục ghi nhớ nào đó. Thông tin này sẽ được sử dung ở phần sau của bài hướng dẫn.</li>
</ol>
<p><img alt="Tạo Lambda Function" src="000037-AWSCloudFormation/images/4.advancedcloudformation/00018-createlambdafunction.png?width=5120px"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/" title="Các tài nguyên tùy chỉnh"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/000037-AWSCloudFormation/vi/4-advancedcloudformation/4.1-customresources/4.1.2-createstack/" title="Tạo Stack" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/000037-AWSCloudFormation/js/clipboard.min.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/perfect-scrollbar.min.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/perfect-scrollbar.jquery.min.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/jquery.sticky.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/featherlight.min.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/highlight.pack.js?1725786021"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/000037-AWSCloudFormation/js/modernizr.custom-3.6.0.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/learn.js?1725786021"></script>
    <script src="/000037-AWSCloudFormation/js/hugo-learn.js?1725786021"></script>

    <link href="/000037-AWSCloudFormation/mermaid/mermaid.css?1725786021" rel="stylesheet" />
    <script src="/000037-AWSCloudFormation/mermaid/mermaid.js?1725786021"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
